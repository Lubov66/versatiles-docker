name: Build all Docker images
on:
  repository_dispatch:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  init:
    name: Init
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.result.outputs.tag }}
    steps:
      - name: get latest tag
        id: result
        run: curl -s https://api.github.com/repos/versatiles-org/versatiles-rs/tags | jq -r '"tag=" + first(.[] | .name | select(startswith("v")))' >> "$GITHUB_OUTPUT"

### BASIC IMAGES

  alpine:
    needs: [init]
    uses: ./.github/workflows/build-single-image.yml
    secrets: inherit
    with:
      variants: alpine,
      filename: basic-alpine
      tag: "${{ needs.init.outputs.tag }}"

  debian:
    needs: [init]
    uses: ./.github/workflows/build-single-image.yml
    secrets: inherit
    with:
      variants: debian
      filename: basic-debian
      tag: "${{ needs.init.outputs.tag }}"

  scratch:
    needs: [init]
    uses: ./.github/workflows/build-single-image.yml
    secrets: inherit
    with:
      variants: scratch
      filename: basic-scratch
      tag: "${{ needs.init.outputs.tag }}"

### FRONTEND IMAGES

  alpine-frontend:
    needs: [init, alpine]
    uses: ./.github/workflows/build-single-image.yml
    secrets: inherit
    with:
      repo: versatiles-frontend
      variants: alpine,
      filename: frontend-alpine
      tag: "${{ needs.init.outputs.tag }}"

  debian-frontend:
    needs: [init, debian]
    uses: ./.github/workflows/build-single-image.yml
    secrets: inherit
    with:
      repo: versatiles-frontend
      variants: debian
      filename: frontend-debian
      tag: "${{ needs.init.outputs.tag }}"

  scratch-frontend:
    needs: [init, scratch]
    uses: ./.github/workflows/build-single-image.yml
    secrets: inherit
    with:
      repo: versatiles-frontend
      variants: scratch
      filename: frontend-scratch
      tag: "${{ needs.init.outputs.tag }}"
